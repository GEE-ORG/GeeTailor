!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.GeeTailor=i()}(this,function(){"use strict";function t(t,i){function e(t,i){Object.keys(i).forEach(function(n){if(n in t){var h=s(t[n]);"[object Object]"===h||"[object Array]"===h?(t[n]=Object.create(t[n]),e(t[n],i[n])):t[n]=i[n]}})}var n=Object.create(t);return e(n,i),n}function i(t){if("undefined"!=typeof Promise&&e(Promise))Promise.resolve().then(function(){t()}).catch(function(t){return console.error(t)});else if("undefined"==typeof MutationObserver||!e(MutationObserver)&&"[object MutationObserverConstructor]"!==MutationObserver.toString())setTimeout(t,0);else{var i=new MutationObserver(t),s=document.createTextNode(a+"");i.observe(s,{characterData:!0}),s.data=++a+"",a=0}}function s(t){return Object.prototype.toString.call(t)}function e(t){return/[native code]/.test(t.toString())}function n(t,i){return new Blob([t],{type:i})}function h(t){return URL.createObjectURL(t)}function r(t,i){var s=JSON.parse(JSON.stringify(i.start)),e=JSON.parse(JSON.stringify(i.end));return s.x>e.x&&(n=[e.x,s.x],s.x=n[0],e.x=n[1]),s.y>e.y&&(h=[e.y,s.y],s.y=h[0],e.y=h[1]),t.x>=s.x&&t.x<=e.x&&t.y>=s.y&&t.y<=e.y;var n,h}function o(t){document.body.style.cursor=t||"auto"}var a=0,c={width:200,height:200,mode:"free",maskType:"circle",resizable:!0,debug:!1};return function(){function s(s,e){var n=this;this.name="GeeTailor",this.dpr=window.devicePixelRatio||1,this.btns={},this.info={},this.svgMask=new Image,this.output=document.createElement("canvas"),this.outCtx=this.output.getContext("2d"),this.rectMaskWidth=0,this.isMoving=!1,this.isMovingCrop=!1,this.isCropping=!1,this.isResizing=!1,this.hasChanged=!0,this.isScaling=!1,this.canvasNotBlank=!1,this.cropStartPoint={x:0,y:0},this.cropEndPoint={x:0,y:0},this.img=new Image,this.original={width:0,height:0},this.imgBounding={width:0,height:0,offsetX:0,offsetY:0},this.cropArea={x:0,y:0,width:0,height:0},this.resizeCtrlWidth=5*this.dpr,this.events={change:[],resize:[function(){return n.dispatch("change")}],scale:[function(){return n.dispatch("change")}],move:[function(){return n.dispatch("change")}],crop:[function(){return n.dispatch("change")}],beforeUpload:[],afterUpload:[],createImg:[]},this.el="string"==typeof s?document.querySelector(s):s,this.option=t(c,e),this.el.innerHTML='\n<div class="gt-canvas" style="display: inline-block">\n    <canvas class="gt-img" style="background-color: rgba(0,0,0,.8)"></canvas>\n    <input class="gt-upload" type="file" accept="image/jpg,image/png" style="display: none">\n    <button class="gt-ctrl_upload">Upload</button>\n    <div class="gt-info" style="position: fixed; width: 120px; top: 0; left: 0; display: none; background: #333; border-radius: 3px; font-size: 12px; padding: 2px 5px; color: #eee">\n        <div class="gt-info_size"></div>\n        <div class="gt-info_color"></div>\n        <div class="gt-info_position"></div>\n    </div>\n</div>\n',i(this.init.bind(this))}return s.prototype.init=function(){var t=this;if(this.wrapper=this.el.querySelector(".gt-canvas"),this.info.size=this.el.querySelector(".gt-info_size"),this.info.color=this.el.querySelector(".gt-info_color"),this.info.position=this.el.querySelector(".gt-info_position"),this.canvas=this.el.querySelector(".gt-img"),this.upload=this.el.querySelector(".gt-upload"),this.btns.upload=this.el.querySelector(".gt-ctrl_upload"),this.ctx=this.canvas.getContext("2d"),this.outCtx.scale(this.dpr,this.dpr),this.mode=this.option.mode,this.canvasInit(),"avatar"===this.mode)if("circle"===this.option.maskType){var i=n('\n<svg width="100px" height="100px" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <path d="M0,0 L100,0 L100,100 L0,100 L0,0 Z M50,100 C77.6142375,100 100,77.6142375 100,50 C100,22.3857625 77.6142375,0 50,0 C22.3857625,0 0,22.3857625 0,50 C0,77.6142375 22.3857625,100 50,100 Z" id="Combined-Shape" stroke="none" fill-opacity="0.5" fill="#000000" fill-rule="evenodd"></path>\n</svg>',"image/svg+xml");this.svgMask.onload=function(){t.ctx.drawImage(t.svgMask,0,0,t.canvas.width,t.canvas.width)},this.svgMask.src=h(i)}else"rect"===this.option.maskType&&(this.rectMaskWidth=this.canvas.width/10,this.canvas.width+=2*this.rectMaskWidth,this.canvas.height+=2*this.rectMaskWidth);else"free"===this.mode&&(this.cropArea={x:0,y:0,width:this.canvas.width,height:this.canvas.height});this.addEvents(),this.render(),console.log(this)},s.prototype.canvasInit=function(){this.canvas.width=this.width*window.devicePixelRatio,this.canvas.height=this.height*window.devicePixelRatio;var t=this.canvas.width*(1/window.devicePixelRatio)+"px",i=this.canvas.height*(1/window.devicePixelRatio)+"px";this.canvas.style.width=this.wrapper.style.width=t,this.canvas.style.height=this.wrapper.style.height=i},s.prototype.render=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBg(),this.drawImg(),this.drawMask()},s.prototype.drawBg=function(){},s.prototype.drawImg=function(){this.ctx.drawImage(this.img,this.imgOffsetX,this.imgOffsetY,this.imgWidth,this.imgHeight)},s.prototype.drawMask=function(){if("avatar"===this.mode){var t=this.option.maskType;if("circle"===t)this.ctx.drawImage(this.svgMask,0,0,this.canvas.width,this.canvas.width);else if("rect"===t){var i=this.canvas.width;this.drawRectMask(this.rectMaskWidth,this.rectMaskWidth,i-2*this.rectMaskWidth,i-2*this.rectMaskWidth)}}else if("free"===this.mode){var s=JSON.parse(JSON.stringify(this.cropStartPoint)),e=JSON.parse(JSON.stringify(this.cropEndPoint));s.x>e.x&&(n=[e.x,s.x],s.x=n[0],e.x=n[1]),s.y>e.y&&(h=[e.y,s.y],s.y=h[0],e.y=h[1]),this.drawRectMask(s.x,s.y,e.x-s.x,e.y-s.y)}this.option.debug&&(this.ctx.fillStyle="#0f0",this.ctx.fillRect(this.cropStartX,this.cropStartY,10,10),this.ctx.fillStyle="#00f",this.ctx.fillRect(this.cropEndX-10,this.cropEndY-10,10,10));var n,h},s.prototype.drawRectMask=function(t,i,s,e){var n=this.canvas.width,h=this.canvas.height;if(this.ctx.fillStyle="rgba(0,0,0,.5)",this.ctx.fillRect(0,0,n,i),this.ctx.fillRect(0,i+e,n,h-(i+e)),this.ctx.fillRect(0,i,t,e),this.ctx.fillRect(t+s,i,n-(t+s),e),this.option.resizable&&s>0&&e>0){var r=this.resizeCtrlWidth;this.ctx.fillStyle="#fff",this.ctx.fillRect(t-r,i-r,r,r),this.ctx.fillRect(t+s,i-r,r,r),this.ctx.fillRect(t-r,i+e,r,r),this.ctx.fillRect(t+s,i+e,r,r);var o=r/2;this.ctx.fillRect(s/2+t-o,i-r,r,r),this.ctx.fillRect(s/2+t-o,i+e,r,r),this.ctx.fillRect(t-r,e/2+i-o,r,r),this.ctx.fillRect(t+s,e/2+i-o,r,r)}},s.prototype.uploadEvents=function(){var t=this;this.btns.upload.addEventListener("click",function(){t.dispatch("beforeUpload"),t.upload.click()}),this.canvas.addEventListener("click",function(){t.dispatch("beforeUpload"),t.canvasNotBlank||t.upload.click()}),this.upload.addEventListener("change",function(i){var s=i.target.files[0],e=h(s);if(!/image\/(jpg|jpeg|png)/.test(s.type))return void console.error("Only support jpg and png format.");URL.revokeObjectURL(t.img.src),t.img.onload=function(){t.imgInit()},t.img.src=e,t.dispatch("afterUpload")})},s.prototype.scrollEvent=function(){var t,i=this,s={x:0,y:0};document.addEventListener("wheel",function(e){if(e.target===i.canvas){i.isScaling=!0,t&&clearTimeout(t),e.preventDefault();var n=e.wheelDeltaY,h=n;o=[e.offsetX,e.offsetY],s.x=o[0],s.y=o[1];var r={x:s.x*i.dpr-i.imgOffsetX,y:s.y*i.dpr-i.imgOffsetY};i.imgWidth+=h,i.imgOffsetX-=r.x/i.imgWidth*h,i.imgOffsetY-=r.y/i.imgHeight*(h/i.ratio),requestAnimationFrame(i.render.bind(i)),t=setTimeout(function(){i.isScaling=!1},200),i.dispatch("scale");var o}})},s.prototype.addEvents=function(){function t(t){if(t.target===this.canvas&&!this.isScaling&&this.canvasNotBlank){console.log("document mousedown"),h.x=t.offsetX,h.y=t.offsetY;var i={x:h.x*this.dpr,y:h.y*this.dpr},s={start:this.cropStartPoint,end:this.cropEndPoint};a=r(i,s),console.log(n),!0===t.metaKey||!0===t.ctrlKey||"avatar"===this.mode||a?(this.isMoving=!0,h.x=t.clientX,h.y=t.clientY,o("move"),a&&(this.isMovingCrop=!0),this.dispatch("move")):n.isInCtrl?(this.isResizing=!0,h.x=t.clientX,h.y=t.clientY,this.dispatch("resize")):(this.isCropping=!0,this.cropStartX=t.offsetX*this.dpr,this.cropStartY=t.offsetY*this.dpr,this.dispatch("crop"))}}function i(t){if(t.preventDefault(),this.canvasNotBlank){var i={x:t.offsetX*this.dpr,y:t.offsetY*this.dpr},s={start:this.cropStartPoint,end:this.cropEndPoint},c=e(t);a=r(i,s);var d=this.getResizeCtrl(t);if(this.isResizing||(n=d),n.flipSideWays=d.flipSideWays,n.flipVertically=d.flipVertically,this.isCropping)o("crosshair");else if(c||a)o("move");else if(n.isInCtrl)switch(n.dir){case"n":case"s":o("ns-resize");break;case"e":case"w":o("ew-resize");break;case"nw":case"se":o("nwse-resize");break;case"ne":case"sw":o("nesw-resize")}else o("auto");if(t.target===this.canvas){var p=this.ctx.getImageData(i.x,i.y,1,1).data;l.style.display="inline-block",l.style.transform="translate("+(t.clientX+20)+"px, "+(t.clientY+20)+"px)",this.info.position.innerText="X: "+i.x/this.dpr+" Y: "+i.y,this.info.color.innerText="RGB("+p[0]+", "+p[1]+", "+p[2]+")"}else l.style.display="none";if((this.isMoving||this.isCropping||this.isResizing)&&!this.isScaling){var g=(t.clientX-h.x)*this.dpr,f=(t.clientY-h.y)*this.dpr;if(this.isMoving)this.isMovingCrop&&!c?(this.cropStartX+=g,this.cropStartY+=f,this.cropEndX+=g,this.cropEndY+=f):(this.imgOffsetX+=g,this.imgOffsetY+=f),this.dispatch("move");else if(this.isCropping)this.cropEndX=t.offsetX*this.dpr,this.cropEndY=t.offsetY*this.dpr,this.dispatch("crop");else if(this.isResizing){switch(n.dir){case"n":this.cropStartY+=f;break;case"e":this.cropEndX+=g;break;case"w":this.cropStartX+=g;break;case"s":this.cropEndY+=f;break;case"nw":this.cropStartX+=g,this.cropStartY+=f;break;case"se":this.cropEndX+=g,this.cropEndY+=f;break;case"ne":this.cropEndX+=g,this.cropStartY+=f;break;case"sw":this.cropStartX+=g,this.cropEndY+=f}this.dispatch("resize")}h.x=t.clientX,h.y=t.clientY,requestAnimationFrame(this.render.bind(this))}}}function s(t){if(this.canvasNotBlank&&(this.isMoving||this.isCropping||this.isResizing)&&!this.isScaling){this.isCropping&&(this.cropEndX=t.offsetX*this.dpr,this.cropEndY=t.offsetY*this.dpr),n.flipSideWays&&(n.flipSideWays=!1,i=[{x:this.cropEndX,y:this.cropStartY},{x:this.cropStartX,y:this.cropEndY}],this.cropStartPoint=i[0],this.cropEndPoint=i[1]),n.flipVertically&&(n.flipVertically=!1,s=[{x:this.cropStartX,y:this.cropEndY},{x:this.cropEndX,y:this.cropStartY}],this.cropStartPoint=s[0],this.cropEndPoint=s[1]),this.isMoving=!1,this.isCropping=!1,this.isMovingCrop=!1,this.isResizing=!1,o("auto"),this.render();var i,s}}function e(t){return(!0===t.metaKey||!0===t.ctrlKey||"avatar"===g.mode)&&t.target===g.canvas}this.uploadEvents(),this.scrollEvent();var n,h={x:0,y:0},a=(this.imgOffsetX,this.imgOffsetY,!1),c=t.bind(this),d=i.bind(this),p=s.bind(this),g=this,l=this.wrapper.querySelector(".gt-info");document.addEventListener("mousedown",c),document.addEventListener("mousemove",d),document.addEventListener("mouseup",p)},s.prototype.imgInit=function(){var t=(this.option,this.img);this.original.width=t.naturalWidth,this.original.height=t.naturalHeight,this.ratio=t.width/t.height,t.width>t.height?this.imgHeight=this.canvas.height:this.imgWidth=this.canvas.width,this.imgOffsetX=(this.canvas.width-this.imgWidth)/2,this.imgOffsetY=(this.canvas.height-this.imgHeight)/2,this.canvasNotBlank=!0,this.render()},s.prototype.center=function(t,i){return{offsetX:(this.canvas.width-t)/2,offsetY:(this.canvas.height-i)/2}},s.prototype.getResizeCtrl=function(t){var i=this,s={isInCtrl:!1,dir:"",flipVertically:!1,flipSideWays:!1},e=JSON.parse(JSON.stringify(this.cropStartPoint)),n=JSON.parse(JSON.stringify(this.cropEndPoint));e.x>n.x&&(f=[n.x,e.x],e.x=f[0],n.x=f[1],s.flipSideWays=!0),e.y>n.y&&(u=[n.y,e.y],e.y=u[0],n.y=u[1],s.flipVertically=!0);var h=e.x,o=e.y,a=n.x-e.x,c=n.y-e.y,d=this.resizeCtrlWidth,p=d/2,g={n:[a/2+h-p,o-d],e:[h+a,c/2+o-p],w:[h-d,c/2+o-p],s:[a/2+h-p,o+c],nw:[h-d,o-d],ne:[h+a,o-d],se:[h+a,o+c],sw:[h-d,o+c]},l={x:t.offsetX*this.dpr,y:t.offsetY*this.dpr};return Object.keys(g).forEach(function(t){if(!s.isInCtrl){var e=g[t],n={start:{x:e[0],y:e[1]},end:{x:e[0]+i.resizeCtrlWidth,y:e[1]+i.resizeCtrlWidth}};r(l,n)&&(s.isInCtrl=!0,s.dir=""+t)}}),s;var f,u},s.prototype.on=function(t,i){"function"!=typeof i&&console.error("Second argument is not a function."),this.events[t].push(i)},s.prototype.dispatch=function(t){var i={target:this.canvas,mode:this.mode,eventName:t,cropArea:{start:this.cropStartPoint,end:this.cropEndPoint},imgBoundingRect:this.imgBounding,originalSize:this.original,dpr:this.dpr,state:{isMoving:this.isMoving,isMovingCrop:this.isMovingCrop,isCropping:this.isCropping,isResizing:this.isResizing,isScaling:this.isScaling}};this.events[t].forEach(function(t){return t(i)})},Object.defineProperty(s.prototype,"mode",{get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case"avatar":this.option.width>this.option.height?this.width=this.height=this.option.height:this.width=this.height=this.option.width;break;case"free":this.width=this.option.width,this.height=this.option.height}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imgWidth",{get:function(){return this.imgBounding.width},set:function(t){var i=Number(t)||this.imgBounding.width;i<100&&(i=100),this.imgBounding.width=i,this.imgBounding.height=i/this.ratio,this.hasChanged=!0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imgHeight",{get:function(){return this.imgBounding.height},set:function(t){var i=Number(t)||this.imgBounding.height;i<100&&(i=100),this.imgBounding.height=i,this.imgBounding.width=i*this.ratio,this.hasChanged=!0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imgOffsetX",{get:function(){return this.imgBounding.offsetX},set:function(t){var i=this.canvas.width-this.canvas.width/10,s=-this.imgWidth+this.canvas.width/10;t=t>i?i:t<-this.imgWidth?s:t,this.imgBounding.offsetX=t,this.hasChanged=!0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imgOffsetY",{get:function(){return this.imgBounding.offsetY},set:function(t){var i=this.canvas.height-this.canvas.height/10,s=-this.imgHeight+this.canvas.height/10;t=t>this.canvas.height?i:t<-this.imgHeight?s:t,this.imgBounding.offsetY=t,this.hasChanged=!0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cropStartX",{get:function(){return this.cropStartPoint.x},set:function(t){this.cropEndX>=this.canvas.width||(this.cropStartPoint.x=Number(t)||0,this.cropStartX<0&&(this.cropStartX=0),this.cropStartX>this.canvas.width&&(this.cropStartX=this.canvas.width),this.hasChanged=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cropStartY",{get:function(){return this.cropStartPoint.y},set:function(t){this.cropEndY>=this.canvas.height||(this.cropStartPoint.y=Number(t)||0,this.cropStartY<0&&(this.cropStartY=0),this.cropStartY>this.canvas.height&&(this.cropStartY=this.canvas.height),this.hasChanged=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cropEndX",{get:function(){return this.cropEndPoint.x},set:function(t){this.cropStartX<=0||(this.cropEndPoint.x=Number(t)||0,this.cropEndX>this.canvas.width&&(this.cropEndX=this.canvas.width),this.cropEndX<0&&(this.cropEndX=0),this.hasChanged=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"cropEndY",{get:function(){return this.cropEndPoint.y},set:function(t){this.cropStartY<=0||(this.cropEndPoint.y=Number(t)||0,this.cropEndY>this.canvas.height&&(this.cropEndY=this.canvas.height),this.cropEndY<0&&(this.cropEndY=0),this.hasChanged=!0)},enumerable:!0,configurable:!0}),s.prototype.createImg=function(){if(this.hasChanged){var t=0,i=0,s=JSON.parse(JSON.stringify(this.cropStartPoint)),e=JSON.parse(JSON.stringify(this.cropEndPoint));"avatar"===this.mode?(t=this.width,i=this.width):"free"===this.mode&&(console.log(s,e),s.x>e.x&&(h=[e.x,s.x],s.x=h[0],e.x=h[1]),s.y>e.y&&(r=[e.y,s.y],s.y=r[0],e.y=r[1]),t=(e.x-s.x)/this.dpr,i=(e.y-s.y)/this.dpr),this.output.width=t,this.output.height=i,this.outCtx.beginPath();var n;"avatar"===this.mode?"circle"===this.option.maskType?(this.outCtx.arc(t/2,t/2,t/2,0,2*Math.PI,!0),this.outCtx.clip(),n=[0,0,this.canvas.width,this.canvas.width,0,0,t,i]):"rect"===this.option.maskType&&(n=[this.rectMaskWidth,this.rectMaskWidth,this.canvas.width-2*this.rectMaskWidth,this.canvas.width-2*this.rectMaskWidth,0,0,t,i]):"free"===this.mode&&(n=[s.x,s.y,e.x-s.x,e.y-s.y,0,0,t,i]),(o=this.outCtx).drawImage.apply(o,[this.canvas].concat(n)),this.hasChanged=!1,this.dispatch("createImg");var h,r,o}},s.prototype.toBase64=function(){return this.createImg(),this.output.toDataURL()},s.prototype.toBlob=function(t){var i=this;return this.createImg(),new Promise(function(t,s){i.output.toBlob(function(i){return t(i)})})},s.prototype.download=function(){this.createImg();var t=document.createElement("a");t.download="gt-img",this.output.toBlob(function(i){t.href=h(i),t.click()})},s}()});
//# sourceMappingURL=GeeTailor.js.map
