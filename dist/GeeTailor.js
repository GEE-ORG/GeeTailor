!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.GeeTailor=i()}(this,function(){"use strict";function t(t,i){function s(t,i){Object.keys(i).forEach(function(n){if(n in t){var h=e(t[n]);"[object Object]"===h||"[object Array]"===h?(t[n]=Object.create(t[n]),s(t[n],i[n])):t[n]=i[n]}})}var n=Object.create(t);return s(n,i),n}function i(t){if("undefined"!=typeof Promise&&s(Promise))Promise.resolve().then(function(){t()}).catch(function(t){return console.error(t)});else if("undefined"==typeof MutationObserver||!s(MutationObserver)&&"[object MutationObserverConstructor]"!==MutationObserver.toString())setTimeout(t,0);else{var i=new MutationObserver(t),e=document.createTextNode(a+"");i.observe(e,{characterData:!0}),e.data=++a+"",a=0}}function e(t){return Object.prototype.toString.call(t)}function s(t){return/[native code]/.test(t.toString())}function n(t,i){return new Blob([t],{type:i})}function h(t){return URL.createObjectURL(t)}var a=0,o=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,i){for(var e=0;e<i.length;e++){var s=i[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(i,e,s){return e&&t(i.prototype,e),s&&t(i,s),i}}(),c=function(t){if(Array.isArray(t)){for(var i=0,e=Array(t.length);i<t.length;i++)e[i]=t[i];return e}return Array.from(t)},d={width:200,height:200,mode:"avatar",maskType:"circle"};return function(){function e(s,n){o(this,e),this.dpr=window.devicePixelRatio||1,this.btns={},this.info={},this.svgMask=new Image,this.output=document.createElement("canvas"),this.outCtx=this.output.getContext("2d"),this.rectMaskWidth=0,this.isMoving=!1,this.hasChanged=!0,this.img=new Image,this.original={width:0,height:0},this.imgBounding={width:0,height:0,offsetX:0,offsetY:0},this.el="string"==typeof s?document.querySelector(s):s,this.option=t(d,n),this.el.innerHTML='\n<div class="gt-canvas" style="display: inline-block">\n    <canvas class="gt-img" style="background-color: rgba(0,0,0,.8)"></canvas>\n    <input class="gt-upload" type="file" accept="image/jpg,image/png" style="display: none">\n    <button class="gt-ctrl_upload">Upload</button>\n    <div class="gt-info">\n        <span class="gt-info_size"></span>\n        <span class="gt-info_color"></span>\n    </div>\n</div>\n',i(this.init.bind(this))}return r(e,[{key:"init",value:function(){var t=this;if(this.wrapper=this.el.querySelector(".gt-canvas"),this.info.size=this.el.querySelector(".gt-info_size"),this.info.color=this.el.querySelector(".gt-info_color"),this.canvas=this.el.querySelector(".gt-img"),this.upload=this.el.querySelector(".gt-upload"),this.btns.upload=this.el.querySelector(".gt-ctrl_upload"),this.ctx=this.canvas.getContext("2d"),this.mode=this.option.mode,this.canvasInit(),"avatar"===this.mode)if("circle"===this.option.maskType){var i=n('\n<svg width="100px" height="100px" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n    <path d="M0,0 L100,0 L100,100 L0,100 L0,0 Z M50,100 C77.6142375,100 100,77.6142375 100,50 C100,22.3857625 77.6142375,0 50,0 C22.3857625,0 0,22.3857625 0,50 C0,77.6142375 22.3857625,100 50,100 Z" id="Combined-Shape" stroke="none" fill-opacity="0.5" fill="#000000" fill-rule="evenodd"></path>\n</svg>',"image/svg+xml");this.svgMask.onload=function(){t.ctx.drawImage(t.svgMask,0,0,t.canvas.width,t.canvas.width)},this.svgMask.src=h(i)}else"rect"===this.option.maskType&&(this.rectMaskWidth=this.canvas.width/10,this.canvas.width+=2*this.rectMaskWidth,this.canvas.height+=2*this.rectMaskWidth);this.addEvents(),this.render(),console.log(this)}},{key:"canvasInit",value:function(){this.canvas.width=this.width*window.devicePixelRatio,this.canvas.height=this.height*window.devicePixelRatio;var t=this.canvas.width*(1/window.devicePixelRatio)+"px",i=this.canvas.height*(1/window.devicePixelRatio)+"px";this.canvas.style.width=this.wrapper.style.width=t,this.canvas.style.height=this.wrapper.style.height=i}},{key:"render",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBg(),this.drawImg(),this.drawMask()}},{key:"drawBg",value:function(){}},{key:"drawImg",value:function(){this.ctx.drawImage(this.img,this.imgOffsetX,this.imgOffsetY,this.imgWidth,this.imgHeight)}},{key:"drawMask",value:function(){if("avatar"===this.mode){var t=this.option.maskType;if("circle"===t)this.ctx.drawImage(this.svgMask,0,0,this.canvas.width,this.canvas.width);else if("rect"===t){var i=this.canvas.width;this.ctx.fillStyle="rgba(0,0,0,.5)",this.ctx.fillRect(0,0,i,this.rectMaskWidth),this.ctx.fillRect(0,i-this.rectMaskWidth,i,this.rectMaskWidth),this.ctx.fillRect(0,this.rectMaskWidth,this.rectMaskWidth,i-2*this.rectMaskWidth),this.ctx.fillRect(i-this.rectMaskWidth,this.rectMaskWidth,this.rectMaskWidth,this.canvas.height-2*this.rectMaskWidth)}}}},{key:"addEvents",value:function(){var t=this;this.btns.upload.addEventListener("click",function(){t.upload.click()}),this.upload.addEventListener("change",function(i){var e=i.target.files[0],s=h(e);if(!/image\/(jpg|jpeg|png)/.test(e.type))return void console.error("Only support jpg and png format.");URL.revokeObjectURL(t.img.src),t.img.onload=function(){t.imgInit()},t.img.src=s});var i=void 0,e={x:0,y:0},s=!1,n=!1;document.addEventListener("wheel",function(n){if(n.target===t.canvas){s=!0,i&&clearTimeout(i),n.preventDefault();var h=n.wheelDeltaY,a=h,o=[n.offsetX,n.offsetY];e.x=o[0],e.y=o[1];var r={x:e.x*t.dpr-t.imgOffsetX,y:e.y*t.dpr-t.imgOffsetY};console.log(e,r),t.imgWidth+=a,t.imgOffsetX-=r.x/t.imgWidth*a,t.imgOffsetY-=r.y/t.imgHeight*(a/t.ratio),requestAnimationFrame(t.render.bind(t)),i=setTimeout(function(){s=!1},200)}});var a={x:0,y:0};this.imgOffsetX,this.imgOffsetY,document.addEventListener("mousedown",function(i){i.target!==t.canvas||s||(n=!0,document.body.style.cursor="move",console.log(i),a.x=i.clientX,a.y=i.clientY)}),document.addEventListener("mousemove",function(i){n&&!s&&(t.imgOffsetX+=(i.clientX-a.x)*t.dpr,t.imgOffsetY+=(i.clientY-a.y)*t.dpr,console.log(t.imgBounding.offsetX,t.imgBounding.offsetY,i.clientX,i.clientY,a.x,a.y),a.x=i.clientX,a.y=i.clientY,requestAnimationFrame(t.render.bind(t)))}),document.addEventListener("mouseup",function(t){n=!1,document.body.style.cursor="auto"})}},{key:"imgInit",value:function(){var t=(this.option,this.img);this.original.width=t.naturalWidth,this.original.height=t.naturalHeight,this.ratio=t.width/t.height,t.width>t.height?this.imgHeight=this.canvas.height:this.imgWidth=this.canvas.width,this.imgOffsetX=(this.canvas.width-this.imgWidth)/2,this.imgOffsetY=(this.canvas.height-this.imgHeight)/2,this.render()}},{key:"center",value:function(t,i){return{offsetX:(this.canvas.width-t)/2,offsetY:(this.canvas.height-i)/2}}},{key:"createImg",value:function(){var t;if(this.hasChanged){var i=this.width,e=this.width;this.output.width=i,this.output.height=e,this.outCtx.beginPath();var s=void 0;"avatar"===this.mode&&("circle"===this.option.maskType?(this.outCtx.arc(i/2,e/2,i/2,0,2*Math.PI,!0),this.outCtx.clip(),s=[0,0,i,e]):"rect"===this.option.maskType&&(s=[this.rectMaskWidth,this.rectMaskWidth,this.canvas.width-2*this.rectMaskWidth,this.canvas.width-2*this.rectMaskWidth,0,0,i,e])),(t=this.outCtx).drawImage.apply(t,[this.canvas].concat(c(s))),this.hasChanged=!1}}},{key:"toBase64",value:function(){return this.createImg(),this.output.toDataURL()}},{key:"toBlob",value:function(t){var i=this;return this.createImg(),new Promise(function(t,e){i.output.toBlob(function(i){return t(i)})})}},{key:"download",value:function(){this.createImg();var t=document.createElement("a");t.download="gt-img",this.output.toBlob(function(i){t.href=h(i),t.click()})}},{key:"mode",get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case"avatar":this.option.width>this.option.height?this.width=this.height=this.option.height:this.width=this.height=this.option.width;break;case"free":this.width=this.option.width,this.height=this.option.height}}},{key:"imgWidth",get:function(){return this.imgBounding.width},set:function(t){var i=Number(t)||this.imgBounding.width;i<100&&(i=100),this.imgBounding.width=i,this.imgBounding.height=i/this.ratio,this.hasChanged=!0}},{key:"imgHeight",get:function(){return this.imgBounding.height},set:function(t){var i=Number(t)||this.imgBounding.height;i<100&&(i=100),this.imgBounding.height=i,this.imgBounding.width=i*this.ratio,this.hasChanged=!0}},{key:"imgOffsetX",get:function(){return this.imgBounding.offsetX},set:function(t){var i=this.canvas.width-this.canvas.width/10,e=-this.imgWidth+this.canvas.width/10;t=t>i?i:t<-this.imgWidth?e:t,this.imgBounding.offsetX=t,this.hasChanged=!0}},{key:"imgOffsetY",get:function(){return this.imgBounding.offsetY},set:function(t){var i=this.canvas.height-this.canvas.height/10,e=-this.imgHeight+this.canvas.height/10;t=t>this.canvas.height?i:t<-this.imgHeight?e:t,this.imgBounding.offsetY=t,this.hasChanged=!0}}]),e}()});
//# sourceMappingURL=GeeTailor.js.map
